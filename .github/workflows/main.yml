name: Build GPU 830 Spoof

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version'
        type: string
        default: '1.0.0'
      version_code:
        description: 'Version code'
        type: string
        default: '100'

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake zip wget
    
    - name: Get NDK
      run: |
        mkdir -p ~/android
        cd ~/android
        wget -q https://dl.google.com/android/repository/android-ndk-r29-linux.zip
        unzip -q android-ndk-r29-linux.zip
        echo "NDK_PATH=$(realpath android-ndk-r29)" >> $GITHUB_ENV
    
    - name: Get Zygisk header
      run: |
        mkdir -p zygisk
        wget -q https://raw.githubusercontent.com/topjohnwu/zygisk-module-sample/master/module/jni/zygisk.hpp -O zygisk/zygisk.hpp
    
    - name: Build ARM64
      run: |
        mkdir -p build_arm64
        cd build_arm64
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-34 \
          -DCMAKE_BUILD_TYPE=Release
        make -j4
        cd ..
    
    - name: Build ARM
      run: |
        mkdir -p build_arm
        cd build_arm
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE="$NDK_PATH/build/cmake/android.toolchain.cmake" \
          -DANDROID_ABI=armeabi-v7a \
          -DANDROID_PLATFORM=android-34 \
          -DCMAKE_BUILD_TYPE=Release
        make -j4
        cd ..
    
    - name: Prepare module
      run: |
        mkdir -p module/zygisk
        
        # کپی کتابخانه‌ها
        cp build_arm64/libgpu_spoof.so module/zygisk/arm64-v8a.so 2>/dev/null || true
        cp build_arm/libgpu_spoof.so module/zygisk/armeabi-v7a.so 2>/dev/null || true
        
        # module.prop
        cat > module/module.prop << EOF
        id=gpu830spoof
        name=Adreno 830 GPU Spoof
        version=${{ github.event.inputs.version }}
        versionCode=${{ github.event.inputs.version_code }}
        author=YourName
        description=Spoof GPU as Adreno 830 for DevCheck
        minMagisk=20.4
        EOF
        
        # customize.sh
        cat > module/customize.sh << 'EOF'
        #!/sbin/sh
        ui_print() { echo "$1"; }
        ui_print "Adreno 830 GPU Spoof"
        ui_print "For: flar2.devcheck"
        set_perm_recursive \$MODPATH 0 0 0755 0644
        EOF
        chmod 755 module/customize.sh
        
        # Magisk files
        mkdir -p module/META-INF/com/google/android
        echo '#!/sbin/sh' > module/META-INF/com/google/android/update-binary
        echo '#MAGISK' > module/META-INF/com/google/android/updater-script
    
    - name: Create ZIP
      run: |
        cd module
        zip -r9 ../GPU830_Spoof-${{ github.event.inputs.version }}.zip .
        cd ..
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: GPU830-Module
        path: GPU830_Spoof-${{ github.event.inputs.version }}.zip
